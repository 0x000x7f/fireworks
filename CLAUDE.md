# AIエージェント（Claude）向け開発・運用マニュアル

このドキュメントは、AIエージェント（Claude）が「日本花火シミュレーション」プロジェクトで開発作業を行う際の、**行動規範、作業手順、および安全規則**を定義するものです。エージェントは、このマニュアルに記載されたルールを**厳格に遵守**し、高品質で安全な開発を遂行してください。

## 🧭 ブランチ構成と作業指針（2025年6月改定）

### 📋 ブランチ役割定義
| ブランチ       | 用途                   | Claudeの作業許可 | 特記事項 |
|----------------|------------------------|------------------|----------|
| `main`         | 各OS共通の参照ドキュメント | ❌ 禁止（参照専用） | README.md、.github/、docs/ のみ |
| `win11`        | Windows環境用ソースコード | ❌ 禁止（人間作業） | 旧main内容を移行 |
| `ubuntu-port`  | Ubuntu/WSL + Claude作業用 | ✅ Claude専用      | AI協調開発専用 |

### 🚨 重要：Claudeは `ubuntu-port` でのみ作業可能
- `main` は今後**参照専用**です
- `win11` は人間専用の作業ブランチです
- 全てのコード編集・commit・pushは `ubuntu-port` でのみ実行してください

---

## 1. 📜 基本原則：継続性の確保

-   **最重要原則**: すべての作業は、**セッション間の継続性**を確保することを最優先とします。あなたの作業履歴は、このプロジェクトの唯一の「記憶」です。
-   **必須行動**: 全ての作業セッションの開始時と終了時に、`docs/PROGRESS_LOG.md`を読み書きしてください。
-   **思考の記録**: なぜそのように実装したのか、どのような選択肢を検討したのかといった**思考プロセス**も、ログに簡潔に残すことが推奨されます。

---

## 2. 🗂️ 作業フロー：セッションごとの手順

### 2.1. セッション開始時
1.  **状況把握**: `docs/PROGRESS_LOG.md` を読み込み、前回の作業内容、完了タスク、未完タスクを完全に理解する。
2.  **タスク計画**: 前回の未完タスクと、今回の新規タスクをリストアップし、実行計画を立てる。

### 2.2. 作業中
1.  **逐次記録**: 重要な機能実装、設計変更、困難だったエラーとその解決策など、特筆すべき事項は作業中に`docs/PROGRESS_LOG.md`へ逐次記録する。
2.  **コミット前確認**: `git commit` を実行する直前には、必ずログが最新の状態になっているか確認する。

### 2.3. セッション終了時
1.  **ログの完成**: `docs/PROGRESS_LOG.md` に、そのセッションで実施した内容を以下のフォーマットで追記し、完成させる。
2.  **状態の保存**:
    -   完了したタスクを明確に記述する。
    -   完了しなかったタスクと、次回セッションで最初に取り組むべきことを明記する。
    -   IDEやPCを再起動する前には、必ずこの手順を完了させる。

### 2.4. ログフォーマット

```markdown
### 📅 日付：YYYY-MM-DD
#### 🚀 本日のゴール
- （例：スターマイン・モードの実装）

#### ✅ 完了タスク
- [x] `PMainFireworks.java` にクリック位置を溜めるリストを追加
- [x] `Firework.java` に時間指定爆発用のコンストラクタを実装
- [x] クリックが止んだら一斉に打ち上げるロジックを `draw()` に追加

#### 🐛 発生した問題と解決策
- （例）問題：`calculateFuseTime`の計算がずれていた。
- （例）解決策：フレームレートに依存しない時間計算に修正。

#### 📝 次回タスク
- [ ] 花火に「風」の影響を追加する物理モデルの設計
- [ ] 新しい花火形状「柳」の実装
```

---

## 3. ⚙️ プロジェクト管理ルール

### 3.1. バージョン管理
-   **定数更新**: 新機能を実装しバージョンが上がる際は、必ず `PMainFireworks.java` 内の `VERSION` 定数（もしあれば）を更新する。
-   **ドキュメント更新**: `README.md` のバージョン履歴と `docs/PROGRESS_LOG.md` の両方に、新しいバージョンの変更点を記載する。
-   **Gitタグ付け (v1.9以降推奨)**: 主要なバージョンアップが完了した際には、Gitタグを付与してリリースのスナップショットを作成する。
    ```bash
    # 例: v1.6の作業が完了したら
    git tag v1.6
    git push origin v1.6
    ```

### 3.2. ファイル操作
-   **操作範囲**: あなたが主に操作するファイルは `src/` ディレクトリ配下と `docs/` ディレクトリ配下です。それ以外のファイル（例: `.idea/`, `pom.xml`の意図しない箇所）の変更には細心の注意を払うこと。
-   **自動生成ファイルの扱い**: `target/` や `deps/` ディレクトリはビルド時に自動生成されるため、直接編集・コミットしない。

---

## 4. ⚠️ 安全規則：実行禁止・要注意コマンド

以下のGitコマンドはプロジェクトの履歴を破壊したり、変更を失うリスクを伴います。**原則として使用を禁止**します。人間からの明確な指示と承認があった場合にのみ、その意図を再確認した上で実行してください。

| コマンド | 危険度 | 説明とリスク |
| :--- | :--- | :--- |
| `git reset --hard` | **極高** | **使用厳禁。** ローカルの全ての変更が復元不可能な形で失われる。 |
| `git clean -fd` | **高** | 未追跡ファイル（新しく作成したファイルなど）が全て削除される。実行前に `git status` で影響範囲を必ず確認すること。 |
| `git rebase` | **中** | コンフリクトの解決が複雑化し、コミット履歴が意図せず改変されるリスクがある。`git merge` を推奨。 |
| `git push --force` | **極高** | **使用厳禁。** リモートリポジトリの履歴を強制的に上書きし、他の開発者の作業を破壊する。 |
| `git rm <file>` | **中** | ファイルを削除するコマンド。本当に削除する意図があるのか、単なる移動やリネームではないかを確認すること。 |

**安全な代替手段:**
-   **変更を取り消したい場合:** `git restore <file>` または `git checkout -- <file>` を使用する。
-   **古いビルドファイル等を掃除したい場合:** `mvn clean` コマンドを使用する。

---

## 5. 🛑 Claudeによる自動操作の禁止事項

### ❌ Git操作に関する禁止事項
- Claudeは **mainブランチ** に対して一切の`add`・`commit`・`push`をしてはいけません。
- Claudeは **win11ブランチ** に対して一切の操作をしてはいけません。
- Claudeは **`rebase`, `reset`, `checkout`, `push --force`** を提案・実行してはいけません。
- Claudeは **untrackedファイルの削除 (`rm -rf`) を実行しないこと**。
- Claudeは `.gitignore` にないファイルを削除対象にしないこと。

### ✅ Git操作で許可される作業（ubuntu-portブランチのみ）
- `git add PROGRESS_LOG.md` や `CLAUDE.md` などのログ関連ファイル
- `git commit -m "作業ログ更新"` 程度の軽微なコミット
- `git push origin ubuntu-port`（ただし前回push済みか確認すること）

---

## 6. 📖 Claudeへの明示ルール

### 🧠 Claudeが常に確認・記録すべきこと
- 現在のブランチ名：`git branch`
- リモート設定：`git remote -v`
- 最新のコミットログ：`git log --oneline -3`

### 🧾 Claudeが残すべきファイル
- `PROGRESS_LOG.md`：セッションの要約と未完タスク
- `CLAUDE.md`：Claudeの使用ルールと制限
- `mcp.log`：実行中のMCPサーバのログ
- その他セッションで生成した設計・記録用ドキュメント

---

## 7. 🚫 削除禁止のファイル・ディレクトリ

以下はClaudeが削除してはいけない：
- `jdk-*`, `apache-maven-*`, `project*`, `target*/`, `SolarSystem*`, `SuikaGame*`
- バイナリ配布物（`.tar.gz`, `.cmd`, `.conf`, `*.Zone.Identifier` 等）
- `.gitignore` に未登録でも削除は必ず人間の許可が必要

---

## 8. ✅ Claudeの作業ルール（再掲）

| 操作項目 | 許可 | 条件 |
|----------|------|------|
| Git Push | ✅   | `ubuntu-port`のみ |
| Rebase   | ❌   | 使用禁止 |
| Reset    | ❌   | 使用禁止 |
| `rm -rf` | ❌   | 手動確認必須 |
| `.gitignore`編集 | ✅ | 変更提案のみ、自動コミット不可 |
| コード編集 | ✅ | 明示されたファイルに限る |
| MCPログ出力 | ✅ | `mcp.log`に保存し、直接標準出力しないこと |

---

## 9. 🔍 目的と効果

| 目的               | 効果                                         |
| ---------------- | ------------------------------------------ |
| Claudeによる暴走操作の防止 | `git rebase`, `rm -rf` などの危険操作を回避          |
| 作業ブランチの明確化       | `main`、`win11` ではなく `ubuntu-port` に限定することで誤pushを防止 |
| セッションの継続性の確保     | Claudeが再起動しても `CLAUDE.md` に基づいて文脈復元できる     |
| 削除禁止対象の明文化       | `.Zone.Identifier` などの誤削除を防ぐ               |

---

**あなたの役割は、安全かつ着実にプロジェクトを進化させることです。不明な点やリスクのある操作については、必ず人間に判断を仰いでください。**